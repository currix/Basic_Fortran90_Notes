<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">

<html>

<head>

<meta http-equiv="content-type" content="text/html; charset=iso-8859-1">

<title>Fortran 90 Lessons for Computational Chemistry - Subprograms (III): modules</title>

<link href="index.html" rel="start">
<link href="ch-clase_9.html" rel="prev">
<link href="ch-clase_11.html" rel="next">
<link href="index.html#contents" rel="contents">
<link href="index.html#copyright" rel="copyright">
<link href="ch-clase_1.html" rel="chapter" title="1 Introduction">
<link href="ch-clase_2.html" rel="chapter" title="2 Basic Operations">
<link href="ch-clase_3.html" rel="chapter" title="3 Introduction to Fortran Arrays">
<link href="ch-clase_4.html" rel="chapter" title="4 More on Arrays">
<link href="ch-clase_7.html" rel="chapter" title="5 Control Structures">
<link href="ch-clase_5.html" rel="chapter" title="6 INPUT/OUTPUT (I)">
<link href="ch-clase_6.html" rel="chapter" title="7 Input/Output (II)">
<link href="ch-clase_8.html" rel="chapter" title="8 Subprograms (I): FUNCTIONS">
<link href="ch-clase_9.html" rel="chapter" title="9 Subprograms (II): subroutines">
<link href="ch-clase_10.html" rel="chapter" title="10 Subprograms (III): modules">
<link href="ch-clase_11.html" rel="chapter" title="11 Subprogramas (IV)">
<link href="ch-clase_blaslap.html" rel="chapter" title="12 Instalación y uso de las bibliotecas BLAS y LAPACK">
<link href="ch-cap_ref.html" rel="chapter" title="13 Referencias">
<link href="ch-clase_1.html#s-sec_11" rel="section" title="1.1 Objectives">
<link href="ch-clase_1.html#s-sec_12" rel="section" title="1.2 Main items.">
<link href="ch-clase_1.html#s-sec_13" rel="section" title="1.3 Example Codes.">
<link href="ch-clase_2.html#s-sec_21" rel="section" title="2.1 Objectives">
<link href="ch-clase_2.html#s-sec_22" rel="section" title="2.2 Main items.">
<link href="ch-clase_2.html#s-sec_23" rel="section" title="2.3 Example Codes.">
<link href="ch-clase_3.html#s-sec_31" rel="section" title="3.1 Objectivos">
<link href="ch-clase_3.html#s-sec_32" rel="section" title="3.2 Main items.">
<link href="ch-clase_3.html#s-sec_33" rel="section" title="3.3 Example Codes.">
<link href="ch-clase_4.html#s-sec_41" rel="section" title="4.1 Objectives">
<link href="ch-clase_4.html#s-sec_42" rel="section" title="4.2 Main items.">
<link href="ch-clase_4.html#s-sec_43" rel="section" title="4.3 Example Codes.">
<link href="ch-clase_7.html#s-sec_71" rel="section" title="5.1 Objectives">
<link href="ch-clase_7.html#s-sec_72" rel="section" title="5.2 Main items.">
<link href="ch-clase_7.html#s-sec_73" rel="section" title="5.3 Example codes.">
<link href="ch-clase_5.html#s-sec_51" rel="section" title="6.1 Objectivos">
<link href="ch-clase_5.html#s-sec_52" rel="section" title="6.2 Main Items.">
<link href="ch-clase_5.html#s-sec_53" rel="section" title="6.3 Example Codes">
<link href="ch-clase_6.html#s-sec_61" rel="section" title="7.1 Objectives">
<link href="ch-clase_6.html#s-sec_62" rel="section" title="7.2 Main items.">
<link href="ch-clase_6.html#s-sec_63" rel="section" title="7.3 Example Codes">
<link href="ch-clase_8.html#s-sec_81" rel="section" title="8.1 Objectives">
<link href="ch-clase_8.html#s-sec_82" rel="section" title="8.2 Main items.">
<link href="ch-clase_8.html#s-sec_83" rel="section" title="8.3 Example Codes">
<link href="ch-clase_9.html#s-sec_91" rel="section" title="9.1 Objectives">
<link href="ch-clase_9.html#s-sec_92" rel="section" title="9.2 Main items.">
<link href="ch-clase_9.html#s-sec_93" rel="section" title="9.3 Example Codes">
<link href="ch-clase_10.html#s-sec_101" rel="section" title="10.1 Objectives">
<link href="ch-clase_10.html#s-sec_102" rel="section" title="10.2 Main items.">
<link href="ch-clase_10.html#s-sec_103" rel="section" title="10.3 Example codes.">
<link href="ch-clase_11.html#s-sec_111" rel="section" title="11.1 Objetivos">
<link href="ch-clase_11.html#s-sec_112" rel="section" title="11.2 Puntos destacables.">
<link href="ch-clase_11.html#s-sec_113" rel="section" title="11.3 Programas usados como ejemplo.">
<link href="ch-clase_blaslap.html#s-sec_bl1" rel="section" title="12.1 Objetivos">
<link href="ch-clase_blaslap.html#s-sec_bl2" rel="section" title="12.2 Puntos destacables.">
<link href="ch-clase_blaslap.html#s-sec_bl3" rel="section" title="12.3 Programas usados como ejemplo.">
<link href="ch-clase_1.html#s-sec_p_1_1" rel="subsection" title="1.3.1 excode_1_1.f90">
<link href="ch-clase_1.html#s-sec_p_1_2" rel="subsection" title="1.3.2 excode_1_2.f90">
<link href="ch-clase_2.html#s-sec_p_2_1" rel="subsection" title="2.3.1 excode_2_1.f90">
<link href="ch-clase_2.html#s-sec_p_2_2" rel="subsection" title="2.3.2 excode_2_2.f90">
<link href="ch-clase_2.html#s-sec_p_2_3" rel="subsection" title="2.3.3 excode_2_3.f90">
<link href="ch-clase_2.html#s-sec_p_2_4" rel="subsection" title="2.3.4 excode_2_4.f90">
<link href="ch-clase_2.html#s-sec_p_2_5" rel="subsection" title="2.3.5 excode_2_5.f90">
<link href="ch-clase_2.html#s-sec_p_2_6" rel="subsection" title="2.3.6 excode_2_6.f90">
<link href="ch-clase_3.html#s-sec_p_3_1" rel="subsection" title="3.3.1 excode_3_1.f90">
<link href="ch-clase_3.html#s-sec_p_3_2" rel="subsection" title="3.3.2 excode_3_2.f90">
<link href="ch-clase_3.html#s-sec_p_3_3" rel="subsection" title="3.3.3 excode_3_3.f90">
<link href="ch-clase_3.html#s-sec_p_3_4" rel="subsection" title="3.3.4 excode_3_4.f90">
<link href="ch-clase_4.html#s-sec_p_4_1" rel="subsection" title="4.3.1 excode_4_1.f90">
<link href="ch-clase_4.html#s-sec_p_4_2" rel="subsection" title="4.3.2 excode_4_2.f90">
<link href="ch-clase_4.html#s-sec_p_4_3" rel="subsection" title="4.3.3 excode_4_3.f90">
<link href="ch-clase_4.html#s-sec_p_4_4" rel="subsection" title="4.3.4 excode_4_4.f90">
<link href="ch-clase_4.html#s-sec_p_4_5" rel="subsection" title="4.3.5 excode_4_5.f90">
<link href="ch-clase_4.html#s-sec_p_4_6" rel="subsection" title="4.3.6 excode_4_6.f90">
<link href="ch-clase_7.html#s-sec_p_7_1" rel="subsection" title="5.3.1 excode_5_1.f90">
<link href="ch-clase_7.html#s-sec_p_7_2" rel="subsection" title="5.3.2 excode_5_2.f90">
<link href="ch-clase_7.html#s-sec_p_7_3" rel="subsection" title="5.3.3 excode_5_3.f90">
<link href="ch-clase_7.html#s-sec_p_7_4" rel="subsection" title="5.3.4 Programa ejemplo_5_4.f90">
<link href="ch-clase_5.html#s-sec_p_5_1" rel="subsection" title="6.3.1 excode_6_1.f90">
<link href="ch-clase_5.html#s-sec_p_5_2" rel="subsection" title="6.3.2 excode_6_2.f90">
<link href="ch-clase_5.html#s-sec_p_5_3" rel="subsection" title="6.3.3 excode_6_3.f90">
<link href="ch-clase_5.html#s-sec_p_5_4" rel="subsection" title="6.3.4 excode_6_4.f90">
<link href="ch-clase_5.html#s-sec_p_5_5" rel="subsection" title="6.3.5 excode_6_5.f90">
<link href="ch-clase_5.html#s-sec_p_5_6" rel="subsection" title="6.3.6 excode_6_6.f90">
<link href="ch-clase_5.html#s-sec_p_5_7" rel="subsection" title="6.3.7 excode_6_7.f90">
<link href="ch-clase_6.html#s-sec_p_6_1" rel="subsection" title="7.3.1 Programa ejemplo_7_1.f90">
<link href="ch-clase_6.html#s-sec_p_6_2" rel="subsection" title="7.3.2 excode_7_2.f90">
<link href="ch-clase_6.html#s-sec_p_6_22" rel="subsection" title="7.3.3 Script ej_here_file">
<link href="ch-clase_6.html#s-sec_p_6_3" rel="subsection" title="7.3.4 excode_7_3.f90">
<link href="ch-clase_6.html#s-sec_p_6_32" rel="subsection" title="7.3.5 namelist input file">
<link href="ch-clase_6.html#s-sec_p_6_4" rel="subsection" title="7.3.6 excode_7_4.f90">
<link href="ch-clase_8.html#s-sec_p_8_1" rel="subsection" title="8.3.1 excode_8_1.f90">
<link href="ch-clase_8.html#s-sec_p_8_2" rel="subsection" title="8.3.2 excode_8_2.f90">
<link href="ch-clase_8.html#s-sec_p_8_3" rel="subsection" title="8.3.3 Programa ejemplo_8_3.f90">
<link href="ch-clase_8.html#s-sec_p_8_4" rel="subsection" title="8.3.4 Programa ejemplo_8_4.f90">
<link href="ch-clase_8.html#s-sec_p_8_5" rel="subsection" title="8.3.5 excode_8_5.f90">
<link href="ch-clase_8.html#s-sec_p_8_6" rel="subsection" title="8.3.6 excode_8_6.f90">
<link href="ch-clase_8.html#s-sec_p_8_7" rel="subsection" title="8.3.7 excode_8_7.f90">
<link href="ch-clase_9.html#s-sec_p_9_1" rel="subsection" title="9.3.1 excode_9_1.f90">
<link href="ch-clase_9.html#s-sec_p_9_2" rel="subsection" title="9.3.2 excode_9_2.f90">
<link href="ch-clase_9.html#s-sec_p_9_3" rel="subsection" title="9.3.3 excode_9_3.f90">
<link href="ch-clase_9.html#s-sec_p_9_4" rel="subsection" title="9.3.4 excode_9_4.f90">
<link href="ch-clase_9.html#s-sec_p_9_5" rel="subsection" title="9.3.5 excode_9_5.f90">
<link href="ch-clase_9.html#s-sec_p_9_6" rel="subsection" title="9.3.6 excode_9_6.f90">
<link href="ch-clase_9.html#s-sec_p_9_7" rel="subsection" title="9.3.7 excode_9_7.f90">
<link href="ch-clase_10.html#s-sec_p_10_1" rel="subsection" title="10.3.1 excode_10_1.f90">
<link href="ch-clase_10.html#s-sec_p_10_1_mod" rel="subsection" title="10.3.2 excode_10_1_mod.f90">
<link href="ch-clase_10.html#s-sec_p_10_2" rel="subsection" title="10.3.3 excode_10_2.f90">
<link href="ch-clase_10.html#s-sec_p_10_2_mod" rel="subsection" title="10.3.4 excode_10_2_mod.f90">
<link href="ch-clase_11.html#s-sec_p_11_1" rel="subsection" title="11.3.1 Programa ejemplo_11_1.f90">
<link href="ch-clase_11.html#s-sec_p_11_2" rel="subsection" title="11.3.2 Programa ejemplo_11_2.f90">
<link href="ch-clase_11.html#s-sec_p_11_3" rel="subsection" title="11.3.3 Programa ejemplo_11_3.f90">
<link href="ch-clase_11.html#s-sec_p_11_4" rel="subsection" title="11.3.4 Programa ejemplo_11_4.f90">
<link href="ch-clase_blaslap.html#s-sec_p_bl_1" rel="subsection" title="12.3.1 Ejemplo de fichero make.inc para LAPACK">
<link href="ch-clase_blaslap.html#s-sec_p_bl_2" rel="subsection" title="12.3.2 Ejemplo de fichero make.inc para LAPACK95">
<link href="ch-clase_blaslap.html#s-sec_p_bl_3" rel="subsection" title="12.3.3 Ejemplo de programa que invoca LAPACK95">
<link href="ch-clase_blaslap.html#s-sec_p_bl_4" rel="subsection" title="12.3.4 Ejemplo de makefile para compilar programas que invocan LAPACK95">

</head>

<body>

<p><a name="ch-clase_10"></a></p>
<hr>

<p>
[ <a href="ch-clase_9.html">previous</a> ]
[ <a href="index.html#contents">Contents</a> ]
[ <a href="ch-clase_1.html">1</a> ]
[ <a href="ch-clase_2.html">2</a> ]
[ <a href="ch-clase_3.html">3</a> ]
[ <a href="ch-clase_4.html">4</a> ]
[ <a href="ch-clase_7.html">5</a> ]
[ <a href="ch-clase_5.html">6</a> ]
[ <a href="ch-clase_6.html">7</a> ]
[ <a href="ch-clase_8.html">8</a> ]
[ <a href="ch-clase_9.html">9</a> ]
[ 10 ]
[ <a href="ch-clase_11.html">11</a> ]
[ <a href="ch-clase_blaslap.html">12</a> ]
[ <a href="ch-cap_ref.html">13</a> ]
[ <a href="ch-clase_11.html">next</a> ]
</p>

<hr>

<h1>
<code>Fortran 90</code> Lessons for Computational Chemistry
<br>Chapter 10 - Subprograms (III): modules
</h1>

<hr>

<h2 id="s-sec_101">10.1 Objectives</h2>

<p>
The main aims of this session consist of:
</p>
<ol type="1" start="1" >
<li>
<p>
Presenting modules and their main pros.
</p>
</li>
</ol>
<ol type="1" start="2" >
<li>
<p>
Use of modules for variable definition, replacing the deprecated
<samp>COMMON</samp> block, a feature of <code>FORTRAN 77</code>.
</p>
</li>
</ol>
<ol type="1" start="3" >
<li>
<p>
Use of modules to define and transmit functions and subroutines.
</p>
</li>
</ol>
<ol type="1" start="4" >
<li>
<p>
Private and publice variables in a module: variable visibility.
</p>
</li>
</ol>

<hr>

<h2 id="s-sec_102">10.2 Main items.</h2>
<ol type="1" start="1" >
<li>
<p>
Modules allow a clearer and more flexible code production.  A module can
encompass
</p>
<ol type="1" start="1" >
<li>
<p>
Global variables declaration.
</p>

<p>
Modules in this regard replace the deprecated <samp>COMMON</samp> and
<samp>INCLUDE</samp> <code>FORTRAN 77</code> features.
</p>
</li>
</ol>
<ol type="1" start="2" >
<li>
<p>
<samp>INTERFACE</samp> blocks declaration.
</p>
</li>
</ol>
<ol type="1" start="3" >
<li>
<p>
Functions and subroutines declaration, avoiding the necessity of including
<samp>INTERFACE</samp> blocks.
</p>
</li>
</ol>
<ol type="1" start="4" >
<li>
<p>
Access control to the different variables, assigning public or private
character.
</p>
</li>
</ol>
<ol type="1" start="5" >
<li>
<p>
Modules allow to pack derived types, functions, subroutines and allow the
development of an object oriented programming approach in <code>FORTRAN</code>.
</p>
</li>
</ol>

<p>
The syntax of a module declaration is as follows
</p>

<pre>
     MODULE <var>module_name</var>
        IMPLICIT NONE
        [SAVE]
          <var>Variable declarations</var>
        [ CONTAINS
          <var>Subprograms definition</var> ]
     END MODULE  <var>module_name</var>
</pre>

<p>
The modules is loaded with the statement <samp>USE MODULE
<var>module_name</var></samp> that has to preceed the rest of the program
statements.  From a module another module can be called.
</p>
</li>
</ol>
<ol type="1" start="2" >
<li>
<p>
Modules allow the transmission of variables between subprogram units without
arguments.  The other main role of modules is, making use of the
<samp>CONTAINS</samp> statement, to define functions, subroutines and
<samp>INTERFACE</samp> blocks.
</p>

<p>
The subprograms inclusion in a module informs the compiler about all the
details of them, allowing a fast error detection.  Subroutines and functions in
a module and accessed with <samp>USE MODULE</samp> it is said to be an
<em>explicit interface</em>, whereas in other case it is said to have an
<em>implicit interface</em>.
</p>
</li>
</ol>
<ol type="1" start="3" >
<li>
<p>
The definition of modules favors the encapsulation of code, defining easily
reusable code, which is the basis of object oriented programming.
</p>
</li>
</ol>
<ol type="1" start="4" >
<li>
<p>
Modules are loaded from other programs or subprograms via the <samp>USE</samp>
command.
</p>
</li>
</ol>
<ol type="1" start="5" >
<li>
<p>
In order to define common variables for several program units the deprecated
<samp>COMMON</samp> feature should be avoided.  Instead the following steps are
necessary
</p>
<ol type="1" start="1" >
<li>
<p>
Declare variables in a <samp>MODULE</samp>.
</p>
</li>
</ol>
<ol type="1" start="2" >
<li>
<p>
Give the variables the <samp>SAVE</samp> attribute.
</p>
</li>
</ol>
<ol type="1" start="3" >
<li>
<p>
Load the modue with the statement <samp>USE</samp> <var>module_name</var>) from
those program units that should access the variables.
</p>
</li>
</ol>

<p>
As an example, if there are several physical constants that are used in severla
programs we can define a module as follows
</p>

<pre>
     MODULE PHYS_CONST
       !
       IMPLICIT NONE
       !
       SAVE
       !
       REAL, PARAMETER :: Light_Speed = 2.99792458E08  ! m/s
       REAL, PARAMETER :: Newton_Ctnt = 6.67428E-11    ! m3 kg-1 s-2
       REAL, PARAMETER :: Planck_Ctnt = 4.13566733E-15 ! eV s
       !
       REAL :: Other_variable
       !
     END MODULE PHYS_CONST
</pre>

<p>
In this module three physical constants are defined (with the
<samp>PARAMETER</samp> attribute) and a fourth variable that is not kept
constant.  Any program unit that needs access to these variables only needs to
load the module as follows
</p>

<pre>
     PROGRAM CALCULUS
       !
       USE PHYS_CONST 
       !
       IMPLICIT NONE
       !
       REAL DISTANCE, TIME
       !
       ...
       DISTANCE = Light_Speed*TIME
       ...
       !
     END PROGRAM CALCULUS
</pre>
</li>
</ol>
<ol type="1" start="6" >
<li>
<p>
The use of modules allows a safe, portable, and flexible way of controlling the
precision of the integer and real numbers in the program.  A possible way to
define in a protable way the precision of a given code is with a module like
<samp>NUMERIC_KINDS</samp> included in <a
href="#s-sec_p_10_1_mod"><samp>excode_10_1_mod.f90</samp>, Section 10.3.2</a>
and we can define the precision using this module
</p>

<pre>
     PROGRAM TEST_MINUIT
       !
       USE NUMERIC_KINDS
       !
       IMPLICIT NONE
       !
       ! Variable Definition     
       REAL(KIND=dp), PARAMETER :: PI = 4.0_dp*ATAN(1.0_dp)
       REAL(KIND=dp) :: ENERF
        ....
        ....
</pre>

<p>
This solution enhances the portability of the code and is less error prone than
individually defining the precision for each program unit.  The example code <a
href="#s-sec_p_10_1"><samp>excode_10_1.f90</samp>, Section 10.3.1</a> is the
same than <a href="ch-clase_9.html#s-sec_p_9_6"><samp>excode_9_6.f90</samp>,
Section 9.3.6</a> apart from this improvement.
</p>
</li>
</ol>
<ol type="1" start="7" >
<li>
<p>
In the source code <a
href="#s-sec_p_10_2_mod"><samp>excode_10_2_mod.f90</samp>, Section 10.3.4</a>
we present a module, defined with the <samp>MODULE</samp> heading instead of
<samp>PROGRAM</samp>, for the definition of an integers <em>stack</em>.  In
this case it is worth to notice the way the variables <samp>STACK_POS</samp>
and <samp>STORE</samp> are defined, as <samp>PRIVATE</samp> variables and with
the <samp>SAVE</samp> attribute.
</p>

<pre>
     PROGRAM Use_Stack
     !
     USE Stack     ! Load the module 
     !
     IMPLICIT NONE
     ....
     ....
     CALL POP(23); CAL PUSH(20)
     ....
     ....
     END PROGRAM Use_Stack
</pre>
</li>
</ol>
<ol type="1" start="8" >
<li>
<p>
As shown in <a href="#s-sec_p_10_2_mod"><samp>excode_10_2_mod.f90</samp>,
Section 10.3.4</a>, variables in a module can have either a private or a public
character, using the <samp>PRIVATE/PUBLIC</samp> attributes.  A private
variable can not be accessed from the calling program unit.  The program
loading the module in the proposed example only can access the <samp>POP</samp>
and <samp>PUSH</samp> subroutines.  The default option is <samp>PUBLIC</samp>
ant it's possible to define the attribute in the same line of the variable
definition.
</p>

<pre>
       INTEGER, PRIVATE, PARAMETER :: STACK_SIZE = 500
       INTEGER, PRIVATE, SAVE :: STORE(STACK_SIZE) = 0, STACK_POS = 0
</pre>
</li>
</ol>
<ol type="1" start="9" >
<li>
<p>
Sometimes it is possible that there are conflicts between a variable or a
subprogram defined in a module are in conflict with variables or subprograms
defined in the calling program unit.  In order to avoid this problem there
exists the possibility of renaming the module variables, though this is a last
minute solution for desperate situations.
</p>

<p>
If, for example, we call the module <samp>Stack</samp> from a main program that
already has a variable called <samp>PUSH</samp>, we can rename the module
<samp>PUSH</samp> object to <samp>STACK_PUSH</samp> when invoking the module.
</p>

<pre>
     USE Stack, STACK_PUSH =&gt; PUSH
</pre>

<p>
Several objects can be simultaneously renamed, separating the list with commas.
</p>
</li>
</ol>
<ol type="1" start="10" >
<li>
<p>
Es posible hacer que solo algunos elementos del módulo sean accesibles desde el
programa que lo invoca con la cláusula <samp>ONLY</samp>, donde también es
posible renombrar los objetos si es necesario.  Por ejemplo, con la llamada
</p>

<pre>
     USE Stack, ONLY: POP, STACK_PUSH =&gt; PUSH
</pre>

<p>
Solamente se accede a <samp>POP</samp> y <samp>PUSH</samp>, y este último se
renombra a <samp>STACK_PUSH</samp>.
</p>
</li>
</ol>
<ol type="1" start="11" >
<li>
<p>
Source code <a href="#s-sec_p_10_2"><samp>excode_10_2.f90</samp>, Section
10.3.3</a> is a simple program where module <a
href="#s-sec_p_10_2_mod"><samp>excode_10_2_mod.f90</samp>, Section 10.3.4</a>
is used to handle a stack to perform integer sums and substraction in reversed
Polish notation (RPN).
</p>

<p>
The RPN does not require the use of parentheses and is faster than the usual
algebraic notation.  If the stack contains, from first to last, the numbers
<samp>(23, 10, 33)</samp> and we take into account the principle tenemos en
cuenta que un stack se rige por el principio <em>last in, first out</em>,
tendremos que si introducimos un número más (p.e.  <samp>5</samp>) y realizamos
las operaciones de suma (<samp>plus</samp>) y substracción (<samp>minus</samp>)
tendremos lo siguiente
</p>

<pre>
     -       -         -              -
     -       23        -              -
     23      10        23             -
     10      33        10             23
     33   -&gt;  5   -&gt;   38 (=33+5) -&gt; -28 (=10-38)
     
     5      plus      minus
</pre>

<p>
Para llevar a cabo esta tarea se carga el módulo <samp>Stack</samp> en
<em>(1)</em>.  Una vez cargado el módulo podemos acceder a las subrutinas
<samp>POP</samp> y <samp>PUSH</samp> que nos permiten manejar el stack.  En
<em>(2)</em> comienza el bucle principal, con la etiqueta <samp>inloop</samp>,
que termina cuando el usuario da como input <samp>Q</samp>, <samp>q</samp> o
<samp>quit</samp>.
</p>

<p>
Para controlar este bucle se utiliza una estructura <samp>SELECT CASE</samp>
que comienza en <em>(3)</em>.  Esta estructura analiza cuatro casos posibles:
</p>
<ul>
<li>
<p>
<em>(4)</em>: salir del programa
</p>
</li>
</ul>
<ul>
<li>
<p>
<em>(5)</em>: suma
</p>
</li>
</ul>
<ul>
<li>
<p>
<em>(6)</em>: resta
</p>
</li>
</ul>
<ul>
<li>
<p>
<em>(7)</em>: introduce número en el stack (<samp>DEFAULT</samp>)
</p>
</li>
</ul>

<p>
En el último caso se transforma la variable de carácter leída en una variable
entera para almacenarla en el stack.
</p>

<p>
Para compilar y correr este programa podemos hacerlo compilando previamente el
módulo, si lo hemos salvado en el fichero <code>ejemplo_10_1_Stack.f90</code>
</p>

<pre>
     $ gfortran -c ejemplo_10_1_Stack.f90
     $ gfortran -o ejemplo_10_2 ejemplo_10_2.f90 ejemplo_10_1_Stack.o
</pre>

<p>
En un ejercicio se plantean al alumnos diferentes maneras de mejorar el
programa simple <a href="#s-sec_p_10_2"><samp>excode_10_2.f90</samp>, Section
10.3.3</a>.
</p>
</li>
</ol>

<hr>

<h2 id="s-sec_103">10.3 Example codes.</h2>

<hr>

<h3 id="s-sec_p_10_1">10.3.1 <samp>excode_10_1.f90</samp></h3>

<pre>
     PROGRAM ex_10_1
       !
       USE NUMERIC_KINDS
       !
       IMPLICIT NONE
       !
       INTEGER :: I, IERR
       REAL(KIND=dp), DIMENSION(:), ALLOCATABLE :: X, Y
       REAL(KIND=dp) :: M, SD, MEDIAN
       ! interface block   
       INTERFACE
          SUBROUTINE STATS(VECTOR,N,MEAN,STD_DEV,MEDIAN)
            !
            USE NUMERIC_KINDS
            !
            IMPLICIT NONE
            INTEGER , INTENT(IN)                    ::  N
            REAL(KIND=dp)      , INTENT(IN) , DIMENSION(:)   :: VECTOR  
            REAL(KIND=dp)      , INTENT(OUT)                 :: MEAN
            REAL(KIND=dp)      , INTENT(OUT)                 :: STD_DEV
            REAL(KIND=dp)      , INTENT(OUT)                 :: MEDIAN
          END SUBROUTINE STATS
       END INTERFACE
       !
       READ*, I  
       !
       ALLOCATE(X(1:I), STAT = IERR)    
       IF (IERR /= 0) THEN
          PRINT*, &quot;X allocation request denied.&quot;
          STOP
       ENDIF
       !
       ALLOCATE(Y(1:I), STAT = IERR)    
       IF (IERR /= 0) THEN
          PRINT*, &quot;Y allocation request denied.&quot;
          STOP
       ENDIF
       !
       CALL BOX_MULLER(I)
       !
       PRINT*, X
       CALL STATS(X,I,M,SD,MEDIAN)
       !
       PRINT *,' MEAN = ',M
       PRINT *,' STANDARD DEVIATION = ',SD
       PRINT *,' MEDIAN IS = ',MEDIAN
       !
       IF (ALLOCATED(X)) DEALLOCATE(X, STAT = IERR) 
       IF (IERR /= 0) THEN
          PRINT*, &quot;X NON DEALLOCATED!&quot;
          STOP
       ENDIF
       PRINT*, Y
       CALL STATS(Y,I,M,SD,MEDIAN)
       !
       PRINT *,' MEAN = ',M
       PRINT *,' STANDARD DEVIATION = ',SD
       PRINT *,' MEDIAN IS = ',MEDIAN
       !
       IF (ALLOCATED(Y)) DEALLOCATE(Y, STAT = IERR)   
       IF (IERR /= 0) THEN
          PRINT*, &quot;Y NON DEALLOCATED!&quot;
          STOP
       ENDIF
       !
     CONTAINS
       !
       SUBROUTINE BOX_MULLER(dim)
         ! 
         ! Uses the Box-Muller method to create two normally distributed vectors
         !
         INTEGER, INTENT(IN) :: dim
         !
         REAL(KIND=dp), PARAMETER :: PI = ACOS(-1.0_dp)
         REAL(KIND=dp), DIMENSION(dim) :: RANDOM_u, RANDOM_v ! Automatic arrays
         !
         CALL RANDOM_NUMBER(RANDOM_u)
         CALL RANDOM_NUMBER(RANDOM_v)
         !
         X = SQRT(-2.0_dp*LOG(RANDOM_u))
         Y = X*SIN(2.0_dp*PI*RANDOM_v)
         X = X*COS(2.0_dp*PI*RANDOM_v)
         !
       END SUBROUTINE BOX_MULLER
       !
     END PROGRAM ex_10_1
     SUBROUTINE STATS(VECTOR,N,MEAN,STD_DEV,MEDIAN)
       USE NUMERIC_KINDS
       IMPLICIT NONE
       ! Defincion de variables
       INTEGER , INTENT(IN)                    ::  N
       REAL(KIND=dp)      , INTENT(IN) , DIMENSION(:)    ::  VECTOR    !! (1)
       REAL(KIND=dp)      , INTENT(OUT)                  ::  MEAN
       REAL(KIND=dp)      , INTENT(OUT)                  ::  STD_DEV
       REAL(KIND=dp)      , INTENT(OUT)                  ::  MEDIAN
       REAL(KIND=dp)      , DIMENSION(1:N)              ::  Y
       REAL(KIND=dp)      :: VARIANCE = 0.0_dp
       REAL(KIND=dp)      :: SUMXI = 0.0_dp, SUMXI2 = 0.0_dp
       !
       SUMXI=SUM(VECTOR)       !! (6)
       SUMXI2=SUM(VECTOR*VECTOR)    !! (6)
       MEAN=SUMXI/N       
       VARIANCE=(SUMXI2-SUMXI*SUMXI/N)/(N-1)
       STD_DEV = SQRT(VARIANCE)
       Y=VECTOR
       ! Ordena valores por proceso de seleccion
       CALL SELECTION
       IF (MOD(N,2) == 0) THEN
          MEDIAN=(Y(N/2)+Y((N/2)+1))/2
       ELSE
          MEDIAN=Y((N/2)+1)
       ENDIF
     CONTAINS     !! (7)
       SUBROUTINE SELECTION
         IMPLICIT NONE
         INTEGER :: I,J,K
         REAL :: MINIMUM
         DO I=1,N-1
            K=I
            MINIMUM=Y(I)
            DO J=I+1,N
               IF (Y(J) &lt; MINIMUM) THEN
                  K=J
                  MINIMUM=Y(K)
               END IF
            END DO
            Y(K)=Y(I)
            Y(I)=MINIMUM
         END DO
       END SUBROUTINE SELECTION
     END SUBROUTINE STATS
</pre>

<hr>

<h3 id="s-sec_p_10_1_mod">10.3.2 <samp>excode_10_1_mod.f90</samp></h3>

<pre>
     MODULE NUMERIC_KINDS
       ! 4, 2, AND 1 BYTE INTEGERS
       INTEGER, PARAMETER :: &amp;
            i4b = SELECTED_INT_KIND(9), &amp;
            i2b = SELECTED_INT_KIND(4), &amp;
            i1b = SELECTED_INT_KIND(2)
       ! SINGLE, DOUBLE, AND QUADRUPLE PRECISION
       INTEGER, PARAMETER :: &amp;
            sp = KIND(1.0), &amp;
            dp = KIND(1.0D0), &amp;
            qp = SELECTED_REAL_KIND(2*PRECISION(1.0_dp))
     END MODULE NUMERIC_KINDS
</pre>

<hr>

<h3 id="s-sec_p_10_2">10.3.3 <samp>excode_10_2.f90</samp></h3>

<pre>
     PROGRAM RPN_CALC
       !
       ! SIMPLE INTEGER RPN CALCULATOR (ONLY SUM AND SUBSTRACT)
       !
       USE Stack                 !!        (1)
       !
       IMPLICIT NONE
       !
       INTEGER :: KEYB_DATA
       CHARACTER(LEN=10) :: INPDAT
       !
       INTEGER :: I, J, K, DATL, NUM, RES
       !
       !
       inloop: DO      !! MAIN LOOP        (2)
          !
          READ 100, INPDAT
          !
          SELECT CASE (INPDAT)   !!        (3)
             !
          CASE ('Q','q','quit')  !! EXIT          (4)
             PRINT*, &quot;End of program&quot;
             EXIT inloop
          CASE ('plus','Plus','PLUS','+')   !! SUM              (5)        
             CALL POP(J)
             CALL POP(K)
             RES = K + J
             PRINT 120, K, J, RES
             CALL PUSH(RES)
          CASE ('minus','Minus','MINUS','-')   !! SUBSTRACT        (6)
             CALL POP(J)
             CALL POP(K)
             RES = K - J
             PRINT 130, K, J, RES
             CALL PUSH(RES)
          CASE DEFAULT !! NUMBER TO STACK  (7)
             !
             DATL = LEN_TRIM(INPDAT)
             !
             RES = 0
             DO I = DATL, 1, -1
                NUM = IACHAR(INPDAT(I:I)) - 48
                RES = RES + NUM*10**(DATL-I)
             ENDDO
             !
             PRINT 110, RES
             CALL PUSH(RES)
          END SELECT
          !
       ENDDO inloop
       !
     100 FORMAT(A10)
     110 FORMAT(1X, I10)
     120 FORMAT(1X, I10,' + ', I10,' = ', I20)
     130 FORMAT(1X, I10,' - ', I10,' = ', I20)
     END PROGRAM RPN_CALC
</pre>

<hr>

<h3 id="s-sec_p_10_2_mod">10.3.4 <samp>excode_10_2_mod.f90</samp></h3>

<pre>
     MODULE Stack
       ! 
       ! MODULE THAT DEFINES A BASIC STACK
       !
       IMPLICIT NONE
       !
       SAVE
       !
       INTEGER, PARAMETER :: STACK_SIZE = 500
       INTEGER, DIMENSION(STACK_SIZE) :: STORE = 0
       INTEGER :: STACK_POS = 0
       !
       PRIVATE :: STORE, STACK_POS, STACK_SIZE
       PUBLIC :: POP, PUSH
       !
       CONTAINS
         !
         SUBROUTINE PUSH(I)
           !
           INTEGER, INTENT(IN) :: I
           !
           IF (STACK_POS &lt; STACK_SIZE) THEN
              !
              STACK_POS = STACK_POS + 1; STORE(STACK_POS) = I
              !
           ELSE
              !
              STOP &quot;FULL STACK ERROR&quot;
              !
           ENDIF
           !
         END SUBROUTINE PUSH
     !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
         SUBROUTINE POP(I)
           !
           INTEGER, INTENT(OUT) :: I
           !
           IF (STACK_POS &gt; 0) THEN
              !
              I = STORE(STACK_POS); STACK_POS = STACK_POS - 1
              !
           ELSE
              !
              STOP &quot;EMPTY STACK ERROR&quot;
              !
           ENDIF
           !
         END SUBROUTINE POP
         !
     END MODULE Stack
</pre>

<hr>

<p>
[ <a href="ch-clase_9.html">previous</a> ]
[ <a href="index.html#contents">Contents</a> ]
[ <a href="ch-clase_1.html">1</a> ]
[ <a href="ch-clase_2.html">2</a> ]
[ <a href="ch-clase_3.html">3</a> ]
[ <a href="ch-clase_4.html">4</a> ]
[ <a href="ch-clase_7.html">5</a> ]
[ <a href="ch-clase_5.html">6</a> ]
[ <a href="ch-clase_6.html">7</a> ]
[ <a href="ch-clase_8.html">8</a> ]
[ <a href="ch-clase_9.html">9</a> ]
[ 10 ]
[ <a href="ch-clase_11.html">11</a> ]
[ <a href="ch-clase_blaslap.html">12</a> ]
[ <a href="ch-cap_ref.html">13</a> ]
[ <a href="ch-clase_11.html">next</a> ]
</p>

<hr>

<p>
<code>Fortran 90</code> Lessons for Computational Chemistry
</p>

<address>
0.0<br>
<br>
Curro Pérez-Bernal <code><a href="mailto:francisco.perez@dfaie.uhu.es">mailto:francisco.perez@dfaie.uhu.es</a></code><br>
<br>
</address>
<hr>

</body>

</html>

